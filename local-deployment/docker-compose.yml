# IMPORTANT:
# Set a unique Compose project name per repo. Otherwise Docker Compose can derive the project name
# from the folder name (e.g. "local-deployment"), leading to cross-repo collisions (containers,
# networks, volumes like "<project>-app-1").
name: server-info-watchdog

services:
  # Server Info Watchdog Service
  watchdog:
    build:
      context: ..
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      # Server identification
      serverName: ${SERVER_NAME}
      gluster_not_installed_handling: ${GLUSTER_NOT_INSTALLED_HANDLING:-warning}
      # Telegram configuration (mapped from .env)
      botToken: ${TELEGRAM_BOT_TOKEN}
      botToken_FILE: ${TELEGRAM_BOT_TOKEN_FILE:-}
      errorChatIDs: ${ERROR_CHAT_IDS}
      warningChatIDs: ${WARNING_CHAT_IDS}
      infoChatIDs: ${INFO_CHAT_IDS}
      # Thresholds and message frequency (JSON)
      WATCHDOG_THRESHOLDS_JSON: ${WATCHDOG_THRESHOLDS_JSON:-}
      WATCHDOG_MESSAGE_FREQUENCY_JSON: ${WATCHDOG_MESSAGE_FREQUENCY_JSON:-}
      # Admin token for web UI
      WATCHDOG_ADMIN_TOKEN: ${WATCHDOG_ADMIN_TOKEN:-}
    volumes:
      # Server info JSONs generated by linux-server-status
      - ../serverInfo:/code/serverInfo:ro
      # Logs directory (also used for state files)
      - ../logs:/code/logs
      # Watchdog configuration file (optional mount)
      - ../watchdog.env:/code/watchdog.env:ro
    networks:
      - backend
    command: ["python", "src/check_server.py"]

  # Admin API Service (for web UI)
  admin-api:
    build:
      context: ..
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      PYTHONUNBUFFERED: "1"
      WATCHDOG_ENV_FILE: /code/watchdog.env
      WATCHDOG_ADMIN_TOKEN: ${WATCHDOG_ADMIN_TOKEN:-}
      WATCHDOG_THRESHOLDS_JSON: ${WATCHDOG_THRESHOLDS_JSON:-}
      WATCHDOG_MESSAGE_FREQUENCY_JSON: ${WATCHDOG_MESSAGE_FREQUENCY_JSON:-}
      serverName: ${SERVER_NAME}
      gluster_not_installed_handling: ${GLUSTER_NOT_INSTALLED_HANDLING:-warning}
      errorChatIDs: ${ERROR_CHAT_IDS}
      warningChatIDs: ${WARNING_CHAT_IDS}
      infoChatIDs: ${INFO_CHAT_IDS}
      ADMIN_API_PORT: "5000"
    volumes:
      - ../watchdog.env:/code/watchdog.env
      - ../logs:/code/logs
      - ../serverInfo:/code/serverInfo
    networks:
      - backend
    command: ["python", "src/admin_api.py"]
    profiles:
      - web

  # Web UI Service
  web:
    build:
      context: ..
      dockerfile: Dockerfile_web
    environment:
      ADMIN_API_HOST: admin-api
      ADMIN_API_PORT: "5000"
    ports:
      - "${WEB_PORT:-8080}:80"
    depends_on:
      - admin-api
    networks:
      - backend
    profiles:
      - web

networks:
  backend:
    driver: bridge
